#!/bin/bash

OUTPUT_DIR="pokemon_data"
mkdir -p "$OUTPUT_DIR"

POKEMON_LIST=("bulbasaur" "ivysaur" "venusaur" "charmander" "charmeleon")

fetch_pokemon() {
  local name=$1
  local retries=3
  local count=0
  local success=0

  while [[ $count -lt $retries ]]; do
    echo "Fetching data for $name... (Attempt $((count + 1)))"
    curl -s "https://pokeapi.co/api/v2/pokemon/$name" -o "$OUTPUT_DIR/$name.json"
    # Check if output file contains valid JSON by checking for a '{' at start (basic check)
    if [[ -s "$OUTPUT_DIR/$name.json" ]] && grep -q '{' "$OUTPUT_DIR/$name.json"; then
      echo "Saved data to $OUTPUT_DIR/$name.json âœ…"
      success=1
      break
    else
      echo "Failed to fetch data for $name. Retrying..."
      ((count++))
      sleep 2
    fi
  done

  if [[ $success -eq 0 ]]; then
    echo "Failed to fetch data for $name after $retries attempts." >> error.log
  fi
}

# Start fetching all in background
for pokemon in "${POKEMON_LIST[@]}"; do
  fetch_pokemon "$pokemon" &
done

echo "Active background jobs:"
jobs

# Wait for all background jobs to complete
wait

echo "All downloads completed."
